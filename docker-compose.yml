# ==========================================================
# docker-compose.yml — Filla SaaS
# Adaptado para Docker Swarm + Traefik existente (rede: ariun)
# ==========================================================
# Deploy via Portainer (Stacks) ou:
#   docker stack deploy -c docker-compose.yml filla
# ==========================================================
# ⚠️  ALTERE os domínios antes de fazer deploy:
#   filla.seudominio.com.br    → domínio do frontend
#   api.filla.seudominio.com.br → domínio da API

version: "3.7"

services:

  # ──────────────────────────────────────────────────────
  # Backend — NestJS API (REST + WebSocket Socket.IO)
  # ──────────────────────────────────────────────────────
  backend:
    image: ghcr.io/dervolpe/filla-backend:latest
    # Ou: build: { context: ./backend }  (se buildar local)
    networks:
      - ariun
    environment:
      PORT: 3000
      DB_HOST: ${DB_HOST:-162.241.203.236}
      DB_PORT: ${DB_PORT:-3306}
      DB_USER: ${DB_USER:-previd39_filla_saas}
      DB_PASS: ${DB_PASS:-T0l3r@nc1@}
      DB_NAME: ${DB_NAME:-previd39_filla_saas}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=ariun"

        ## Roteador HTTPS da API
        - "traefik.http.routers.filla-api.rule=Host(`api.filla.seudominio.com.br`)"
        - "traefik.http.routers.filla-api.entrypoints=websecure"
        - "traefik.http.routers.filla-api.tls=true"
        - "traefik.http.routers.filla-api.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.filla-api.service=filla-api-svc"
        - "traefik.http.routers.filla-api.priority=10"

        ## Serviço → porta interna do NestJS
        - "traefik.http.services.filla-api-svc.loadbalancer.server.port=3000"

        ## WebSocket: aumenta timeout para Socket.IO funcionar
        - "traefik.http.services.filla-api-svc.loadbalancer.sticky.cookie=true"

  # ──────────────────────────────────────────────────────
  # Frontend — Vue 3 via Nginx
  # ──────────────────────────────────────────────────────
  frontend:
    image: ghcr.io/dervolpe/filla-frontend:latest
    # Ou: build: { context: ./frontend }  (se buildar local)
    networks:
      - ariun
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=ariun"

        ## Roteador HTTPS do frontend
        - "traefik.http.routers.filla-app.rule=Host(`filla.seudominio.com.br`)"
        - "traefik.http.routers.filla-app.entrypoints=websecure"
        - "traefik.http.routers.filla-app.tls=true"
        - "traefik.http.routers.filla-app.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.filla-app.service=filla-app-svc"
        - "traefik.http.routers.filla-app.priority=10"

        ## Serviço → porta 80 do Nginx
        - "traefik.http.services.filla-app-svc.loadbalancer.server.port=80"

networks:
  ariun:
    external: true
    name: ariun
